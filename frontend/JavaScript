document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const basicPrompt = document.getElementById('basicPrompt');
    const charCount = document.getElementById('charCount');
    const categorySelect = document.getElementById('categorySelect');
    const toneSelect = document.getElementById('toneSelect');
    const includeExamples = document.getElementById('includeExamples');
    const specifyFormat = document.getElementById('specifyFormat');
    const apiEndpoint = document.getElementById('apiEndpoint');
    const enhanceBtn = document.getElementById('enhanceBtn');
    const enhancedOutput = document.getElementById('enhancedOutput');
    const copyBtn = document.getElementById('copyBtn');
    const saveBtn = document.getElementById('saveBtn');
    const qualityBadge = document.getElementById('qualityBadge');
    const qualityBar = document.getElementById('qualityBar');
    const qualityScore = document.getElementById('qualityScore');
    const promptInfo = document.getElementById('promptInfo');
    const statsSection = document.getElementById('statsSection');
    const wordCount = document.getElementById('wordCount');
    const tokenCount = document.getElementById('tokenCount');
    const categoryBadge = document.getElementById('categoryBadge');
    const analysisResults = document.getElementById('analysisResults');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const errorDetails = document.getElementById('errorDetails');
    const retryBtn = document.getElementById('retryBtn');
    const exampleButtons = document.querySelectorAll('.example-btn');

    // Character counter
    basicPrompt.addEventListener('input', function() {
        charCount.textContent = this.value.length;
    });

    // Example button handlers
    exampleButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const prompt = this.getAttribute('data-prompt');
            basicPrompt.value = prompt;
            charCount.textContent = prompt.length;
            
            // Auto-select appropriate category
            if (prompt.toLowerCase().includes('python') || prompt.toLowerCase().includes('function')) {
                categorySelect.value = 'code_generation';
            } else if (prompt.toLowerCase().includes('story') || prompt.toLowerCase().includes('fantasy')) {
                categorySelect.value = 'creative_writing';
            } else if (prompt.toLowerCase().includes('business') || prompt.toLowerCase().includes('proposal')) {
                categorySelect.value = 'business_communication';
            }
        });
    });

    // Enhance button handler
    enhanceBtn.addEventListener('click', async function() {
        const prompt = basicPrompt.value.trim();
        if (!prompt) {
            showError('Please enter a prompt first!');
            return;
        }

        // Show loading state
        setLoadingState(true);
        
        try {
            const endpoint = apiEndpoint.value.trim();
            if (!endpoint || endpoint === 'https://your-render-app.onrender.com') {
                throw new Error('Please set your Render backend URL in the API Endpoint field');
            }

            const requestData = {
                prompt: prompt,
                category: categorySelect.value === 'auto' ? null : categorySelect.value,
                tone: toneSelect.value,
                include_examples: includeExamples.checked,
                target_length: 'detailed'
            };

            const response = await fetch(`${endpoint}/api/v1/enhance`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            // Display enhanced prompt
            displayEnhancedPrompt(result);
            showStats(result);
            showAnalysis(result);
            
            // Set success state
            setLoadingState(false);
            showError(false);
            
        } catch (error) {
            console.error('Error:', error);
            showError(error.message);
            setLoadingState(false);
        }
    });

    // Copy button handler
    copyBtn.addEventListener('click', function() {
        const text = enhancedOutput.textContent;
        navigator.clipboard.writeText(text).then(() => {
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
            copyBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
            copyBtn.classList.add('bg-green-100', 'text-green-700');
            
            setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>Copy';
                copyBtn.classList.remove('bg-green-100', 'text-green-700');
                copyBtn.classList.add('bg-gray-100', 'hover:bg-gray-200');
            }, 2000);
        });
    });

    // Save button handler (local storage)
    saveBtn.addEventListener('click', function() {
        const prompt = enhancedOutput.textContent;
        const timestamp = new Date().toISOString();
        const key = `saved_prompt_${Date.now()}`;
        
        const savedPrompt = {
            id: key,
            prompt: prompt,
            timestamp: timestamp,
            category: categoryBadge.textContent
        };
        
        // Get existing saved prompts
        const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '[]');
        savedPrompts.push(savedPrompt);
        localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));
        
        // Visual feedback
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved!';
        saveBtn.classList.remove('bg-blue-50', 'hover:bg-blue-100', 'text-blue-600');
        saveBtn.classList.add('bg-green-100', 'text-green-700');
        
        setTimeout(() => {
            saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save';
            saveBtn.classList.remove('bg-green-100', 'text-green-700');
            saveBtn.classList.add('bg-blue-50', 'hover:bg-blue-100', 'text-blue-600');
        }, 2000);
    });

    // Retry button handler
    retryBtn.addEventListener('click', function() {
        enhanceBtn.click();
    });

    // Helper functions
    function setLoadingState(isLoading) {
        if (isLoading) {
            loadingSpinner.classList.remove('hidden');
            enhancedOutput.classList.add('hidden');
            statsSection.classList.add('hidden');
            copyBtn.classList.add('hidden');
            saveBtn.classList.add('hidden');
            qualityBadge.classList.add('hidden');
            enhanceBtn.disabled = true;
            enhanceBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Processing...';
        } else {
            loadingSpinner.classList.add('hidden');
            enhancedOutput.classList.remove('hidden');
            enhanceBtn.disabled = false;
            enhanceBtn.innerHTML = '<i class="fas fa-magic mr-3"></i>Enhance Prompt Now';
        }
    }

    function showError(message) {
        if (message) {
            errorMessage.classList.remove('hidden');
            enhancedOutput.classList.add('hidden');
            statsSection.classList.add('hidden');
            errorDetails.textContent = message;
        } else {
            errorMessage.classList.add('hidden');
        }
    }

    function displayEnhancedPrompt(result) {
        enhancedOutput.innerHTML = `
            <div class="typewriter">
                <div class="text-sm text-gray-500 mb-4">
                    <div class="flex items-center space-x-4">
                        <span><i class="fas fa-calendar mr-1"></i> ${new Date(result.created_at).toLocaleString()}</span>
                        <span><i class="fas fa-fingerprint mr-1"></i> ID: ${result.id}</span>
                    </div>
                </div>
                <div class="whitespace-pre-wrap text-gray-800 leading-relaxed">
                    ${result.enhanced_prompt.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
        
        promptInfo.textContent = `Enhanced from "${result.original_prompt.substring(0, 50)}${result.original_prompt.length > 50 ? '...' : ''}"`;
        copyBtn.classList.remove('hidden');
        saveBtn.classList.remove('hidden');
    }

    function showStats(result) {
        statsSection.classList.remove('hidden');
        wordCount.textContent = result.word_count;
        tokenCount.textContent = result.token_estimate;
        categoryBadge.textContent = result.category.replace('_', ' ').toUpperCase();
        
        // Update quality badge
        qualityBadge.classList.remove('hidden');
        qualityScore.textContent = `${Math.round(result.quality_score)}%`;
        qualityBar.style.width = `${result.quality_score}%`;
        
        // Update color based on score
        if (result.quality_score >= 80) {
            qualityBar.classList.remove('bg-yellow-500', 'bg-red-500');
            qualityBar.classList.add('bg-green-500');
        } else if (result.quality_score >= 60) {
            qualityBar.classList.remove('bg-green-500', 'bg-red-500');
            qualityBar.classList.add('bg-yellow-500');
        } else {
            qualityBar.classList.remove('bg-green-500', 'bg-yellow-500');
            qualityBar.classList.add('bg-red-500');
        }
    }

    function showAnalysis(result) {
        const checks = [
            { name: 'Clear Objective', value: result.word_count > 50 },
            { name: 'Specific Requirements', value: result.enhanced_prompt.toLowerCase().includes('specific') || result.enhanced_prompt.toLowerCase().includes('detailed') },
            { name: 'Format Specified', value: result.enhanced_prompt.toLowerCase().includes('format') || result.enhanced_prompt.toLowerCase().includes('structure') },
            { name: 'Constraints Defined', value: result.enhanced_prompt.toLowerCase().includes('constraint') || result.enhanced_prompt.toLowerCase().includes('must') },
            { name: 'Appropriate Length', value: result.word_count >= 100 && result.word_count <= 500 },
            { name: 'Professional Tone', value: result.metadata.tone === 'professional' || result.enhanced_prompt.toLowerCase().includes('professional') }
        ];

        analysisResults.innerHTML = checks.map(check => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span class="font-medium">${check.name}</span>
                <span class="${check.value ? 'text-green-600' : 'text-red-600'}">
                    <i class="fas fa-${check.value ? 'check-circle' : 'times-circle'} mr-1"></i>
                    ${check.value ? 'Pass' : 'Fail'}
                </span>
            </div>
        `).join('');
    }

    // Initialize
    charCount.textContent = basicPrompt.value.length;
});
